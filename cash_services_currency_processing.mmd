%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#fff', 'primaryTextColor':'#333', 'lineColor':'#333'}}}%%
flowchart TB
    %% Cash Services - Currency Processing Workflow
    
    %% Intake Subgraph
    subgraph INTAKE[INTAKE]
        direction TB
        I1[Currency Exchange Request]
        I2[Customer Verification]
        I3[Currency Type Identification]
        I4[Amount Specification]
        I5[Rate Confirmation]
        I6[Initial Documentation]
        
        I1 --> I2
        I2 --> I3
        I3 --> I4
        I4 --> I5
        I5 --> I6
    end
    
    %% Triage Subgraph
    subgraph TRIAGE[TRIAGE]
        direction TB
        T1{Transaction Type}
        T2[Buy Foreign Currency]
        T3[Sell Foreign Currency]
        T4[Currency Exchange]
        T5[Traveler's Checks]
        T6[Wire in Foreign Currency]
        T7{Amount Category}
        T8[Small Transaction]
        T9[Medium Transaction]
        T10[Large Transaction]
        
        T1 -->|Buy| T2
        T1 -->|Sell| T3
        T1 -->|Exchange| T4
        T1 -->|Checks| T5
        T1 -->|Wire| T6
        
        T2 --> T7
        T3 --> T7
        T4 --> T7
        T5 --> T7
        T6 --> T7
        
        T7 -->|< $1,000| T8
        T7 -->|$1,000-$10,000| T9
        T7 -->|> $10,000| T10
    end
    
    %% Fulfillment Subgraph
    subgraph FULFILLMENT[FULFILLMENT]
        direction TB
        F1[Verify Currency Availability]
        F2[Calculate Exchange Rate]
        F3[Apply Fees and Charges]
        F4[Count and Authenticate Bills]
        F5[Process Transaction]
        F6[Update Inventory]
        F7[Issue Receipt]
        F8[Provide Currency]
        F9[Record in System]
        
        F1 --> F2
        F2 --> F3
        F3 --> F4
        F4 --> F5
        F5 --> F6
        F6 --> F7
        F7 --> F8
        F8 --> F9
    end
    
    %% Investigations Subgraph
    subgraph INVESTIGATIONS[INVESTIGATIONS]
        direction TB
        IV1{Suspicious Activity?}
        IV2[Review Transaction History]
        IV3[Verify Source of Funds]
        IV4[Check Sanctions Lists]
        IV5[Analyze Patterns]
        IV6[Document Review]
        IV7[Customer Interview]
        IV8{Clear to Proceed?}
        
        IV1 -->|Yes| IV2
        IV2 --> IV3
        IV3 --> IV4
        IV4 --> IV5
        IV5 --> IV6
        IV6 --> IV7
        IV7 --> IV8
    end
    
    %% Escalations Subgraph
    subgraph ESCALATIONS[ESCALATIONS]
        direction TB
        E1[Flag Transaction]
        E2[Notify Compliance Officer]
        E3[Senior Management Review]
        E4[Legal Consultation]
        E5[Regulatory Reporting Decision]
        E6[Final Disposition]
        E7[Customer Communication]
        
        E1 --> E2
        E2 --> E3
        E3 --> E4
        E4 --> E5
        E5 --> E6
        E6 --> E7
    end
    
    %% Risk Controls Subgraph
    subgraph RISK_CONTROLS[RISK CONTROLS]
        direction TB
        R1[KYC Verification]
        R2[AML Screening]
        R3[OFAC Check]
        R4[Transaction Limits]
        R5[Currency Authenticity]
        R6[Rate Validation]
        R7{Risk Assessment}
        R8[Enhanced Due Diligence]
        R9[CTR Filing]
        R10[SAR Evaluation]
        
        R1 --> R7
        R2 --> R7
        R3 --> R7
        R4 --> R7
        R5 --> R7
        R6 --> R7
        
        R7 -->|High Risk| R8
        R7 -->|>$10,000 Cash| R9
        R8 --> R10
    end
    
    %% Support Operations Management Subgraph
    subgraph SUPPORT_OPS[SUPPORT - OPERATIONS MANAGEMENT]
        direction LR
        SO1[Currency Inventory Management]
        SO2[Rate Updates and Distribution]
        SO3[Teller Training]
        SO4[Cash Vault Management]
        SO5[Equipment Maintenance]
        SO6[Daily Balancing]
        
        SO1 --> SO2
        SO2 --> SO3
        SO3 --> SO4
        SO4 --> SO5
        SO5 --> SO6
    end
    
    %% Support Process Management Subgraph
    subgraph SUPPORT_PROCESS[SUPPORT - PROCESS MANAGEMENT]
        direction LR
        SP1[Regulatory Compliance Updates]
        SP2[Policy and Procedure Maintenance]
        SP3[System Configuration]
        SP4[Audit Trail Management]
        SP5[Reporting Requirements]
        SP6[Cross-Border Regulations]
        
        SP1 --> SP2
        SP2 --> SP3
        SP3 --> SP4
        SP4 --> SP5
        SP5 --> SP6
    end
    
    %% Main Flow Connections
    INTAKE --> TRIAGE
    TRIAGE --> RISK_CONTROLS
    RISK_CONTROLS -->|Low/Medium Risk| FULFILLMENT
    RISK_CONTROLS -->|High Risk| INVESTIGATIONS
    FULFILLMENT --> END_SUCCESS[Transaction Complete]
    INVESTIGATIONS -->|Cleared| FULFILLMENT
    INVESTIGATIONS -->|Issues| ESCALATIONS
    ESCALATIONS -->|Approved| FULFILLMENT
    ESCALATIONS -->|Denied| END_DENIED[Transaction Denied]
    
    %% Support Connections
    SUPPORT_OPS -.->|Enables| INTAKE
    SUPPORT_OPS -.->|Maintains| FULFILLMENT
    SUPPORT_PROCESS -.->|Governs| RISK_CONTROLS
    SUPPORT_PROCESS -.->|Guides| ESCALATIONS
    
    %% Styling
    classDef intakeStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef triageStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef fulfillmentStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#000
    classDef investigationStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef escalationStyle fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    classDef riskStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000
    classDef supportOpsStyle fill:#e0f2f1,stroke:#00796b,stroke-width:2px,color:#000
    classDef supportProcStyle fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#000
    classDef successStyle fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#000
    classDef deniedStyle fill:#ffcdd2,stroke:#c62828,stroke-width:3px,color:#000
    
    class INTAKE intakeStyle
    class TRIAGE triageStyle
    class FULFILLMENT fulfillmentStyle
    class INVESTIGATIONS investigationStyle
    class ESCALATIONS escalationStyle
    class RISK_CONTROLS riskStyle
    class SUPPORT_OPS supportOpsStyle
    class SUPPORT_PROCESS supportProcStyle
    class END_SUCCESS successStyle
    class END_DENIED deniedStyle